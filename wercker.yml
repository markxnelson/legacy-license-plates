# Copyright 2017, Oracle Corporation and/or affiliates.  All rights reserved.

services:
  - name: database 
    id: container-registry.oracle.com/database/enterprise
    username: $OCR_USERNAME
    password: $OCR_PASSWORD
    tag: latest

box:
  id: quay.io/ravi_r_singhal/weblogic
  username: $QUAY_USERNAME
  password: $QUAY_PASSWORD
  tag: latest
  ports:
   - "7001"
 
dev:
 steps:
  - script: 
     name: "Wait for DB connection" 
     code: | 
      # Wait for 1521 to open
      while ! nc $DATABASE_PORT_1521_TCP_ADDR $DATABASE_PORT_1521_TCP_PORT < /dev/null; do sleep 3; done
      # sleep for some extra time for db setup
      sleep 80
  - script: 
     name: "Create Tables" 
     code: |       
      export LD_LIBRARY_PATH=/usr/lib/oracle/12.2/client64/lib
      ls -lahrt
      export SQL_PLUS_CMD="sqlplus64 -S sys/$DATABASE_ENV_DB_PASSWD@$DATABASE_PORT_1521_TCP_ADDR:$DATABASE_PORT_1521_TCP_PORT/$DATABASE_ENV_DB_SID.$DATABASE_ENV_DB_DOMAIN as sysdba @createSchema.sql"
      #/bin/bash
      echo $SQL_PLUS_CMD
      eval $SQL_PLUS_CMD
      echo "Done creating table"
  - script: 
     name: "Create Application war" 
     code: | 
      echo "Check for Maven repo access"      
      status="$(curl --max-time 5 -Is https://repo.maven.apache.org | head -1)"
      validate=( $status )
      if [ "${validate[1]}" == "200" ]; then
        cd $WERCKER_SOURCE_DIR
        mvn clean install
        cp target/licenseplates.war /u01/oracle/.
      else
        echo "No internet access.Will use the prebuilt war"
      fi     
  - script: 
     name: "Create Domain and Deploy App" 
     code: |       
      export MW_HOME="$ORACLE_HOME" 
      export DOMAIN_HOME=/u01/oracle/user_projects/domains/base_domain
      export PATH=$PATH:/u01/oracle:$DOMAIN_HOME
      export APP_NAME="licenseplates"
      export APP_PKG_FILE="licenseplates.war"
      export APP_PKG_LOCATION="/u01/oracle"
      export DATABASE_DS_URL="jdbc:oracle:thin:@//$DATABASE_PORT_1521_TCP_ADDR:$DATABASE_PORT_1521_TCP_PORT/$DATABASE_ENV_DB_SID.$DATABASE_ENV_DB_DOMAIN"
      cp -R container-scripts/*  /u01/oracle/.
      chmod +xr /u01/oracle/*.sh
      chmod +xr /u01/oracle/*.py
      chmod +xr /u01/oracle/wlst 
      cd /u01/oracle
      ./ds-wlst-online-config.sh
      wlst /u01/oracle/app-deploy-online.py    
  - internal/watch:
     name: "Run it!"
     code: |
      echo "App is ready for use"
     
  - internal/docker-push:
     username: $QUAY_USERNAME
     password: $QUAY_PASSWORD
     tag: demo-ready
     repository: quay.io/ravi_r_singhal/weblogic
     registry: https://quay.io
     cmd: /u01/oracle/user_projects/domains/base_domain/startWebLogic.sh
     ports: 7001 
